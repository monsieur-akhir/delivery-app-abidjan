{"ast":null,"code":"\"use client\";\n\nimport _defineProperty from \"@babel/runtime/helpers/defineProperty\";\nimport _slicedToArray from \"@babel/runtime/helpers/slicedToArray\";\nfunction ownKeys(e, r) { var t = Object.keys(e); if (Object.getOwnPropertySymbols) { var o = Object.getOwnPropertySymbols(e); r && (o = o.filter(function (r) { return Object.getOwnPropertyDescriptor(e, r).enumerable; })), t.push.apply(t, o); } return t; }\nfunction _objectSpread(e) { for (var r = 1; r < arguments.length; r++) { var t = null != arguments[r] ? arguments[r] : {}; r % 2 ? ownKeys(Object(t), !0).forEach(function (r) { _defineProperty(e, r, t[r]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : ownKeys(Object(t)).forEach(function (r) { Object.defineProperty(e, r, Object.getOwnPropertyDescriptor(t, r)); }); } return e; }\nimport { createContext, useContext, useState, useEffect, useCallback } from \"react\";\nimport { WS_URL } from \"../config/environment\";\nimport { useAuth } from \"./AuthContext\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nvar WebSocketContext = createContext({\n  connected: false,\n  sendMessage: function sendMessage() {},\n  lastMessage: null,\n  subscribe: function subscribe() {\n    return function () {};\n  },\n  unsubscribe: function unsubscribe() {}\n});\nexport var useWebSocket = function useWebSocket() {\n  return useContext(WebSocketContext);\n};\nexport var WebSocketProvider = function WebSocketProvider(_ref) {\n  var children = _ref.children;\n  var _useAuth = useAuth(),\n    user = _useAuth.user,\n    token = _useAuth.token;\n  var _useState = useState(null),\n    _useState2 = _slicedToArray(_useState, 2),\n    socket = _useState2[0],\n    setSocket = _useState2[1];\n  var _useState3 = useState(false),\n    _useState4 = _slicedToArray(_useState3, 2),\n    connected = _useState4[0],\n    setConnected = _useState4[1];\n  var _useState5 = useState(null),\n    _useState6 = _slicedToArray(_useState5, 2),\n    lastMessage = _useState6[0],\n    setLastMessage = _useState6[1];\n  var _useState7 = useState({}),\n    _useState8 = _slicedToArray(_useState7, 2),\n    subscriptions = _useState8[0],\n    setSubscriptions = _useState8[1];\n  var getWsUrl = function getWsUrl() {\n    return WS_URL + \"/\" + (user == null ? void 0 : user.id) + \"?token=\" + token;\n  };\n  var connectWebSocket = useCallback(function () {\n    if (!token || !user) return;\n    var ws = new WebSocket(getWsUrl());\n    ws.onopen = function () {\n      console.log(\"WebSocket connected\");\n      setConnected(true);\n    };\n    ws.onmessage = function (event) {\n      try {\n        var message = JSON.parse(event.data);\n        setLastMessage(message);\n        if (message.type && subscriptions[message.type]) {\n          subscriptions[message.type](message.data);\n        }\n      } catch (error) {\n        console.error(\"Error parsing WebSocket message:\", error);\n      }\n    };\n    ws.onclose = function () {\n      console.log(\"WebSocket disconnected\");\n      setConnected(false);\n      setTimeout(function () {\n        if (token && user) {\n          connectWebSocket();\n        }\n      }, 5000);\n    };\n    ws.onerror = function (error) {\n      console.error(\"WebSocket error:\", error);\n      ws.close();\n    };\n    setSocket(ws);\n    return function () {\n      ws.close();\n    };\n  }, [token, user, subscriptions]);\n  useEffect(function () {\n    if (token && user) {\n      var cleanup = connectWebSocket();\n      return cleanup;\n    }\n  }, [token, user, connectWebSocket]);\n  var sendMessage = useCallback(function (message) {\n    if (socket && connected) {\n      socket.send(JSON.stringify(message));\n    }\n  }, [socket, connected]);\n  var subscribe = useCallback(function (channel, callback) {\n    setSubscriptions(function (prev) {\n      return _objectSpread(_objectSpread({}, prev), {}, _defineProperty({}, channel, callback));\n    });\n    return function () {\n      unsubscribe(channel);\n    };\n  }, []);\n  var unsubscribe = useCallback(function (channel) {\n    setSubscriptions(function (prev) {\n      var newSubscriptions = _objectSpread({}, prev);\n      delete newSubscriptions[channel];\n      return newSubscriptions;\n    });\n  }, []);\n  return _jsx(WebSocketContext.Provider, {\n    value: {\n      connected: connected,\n      sendMessage: sendMessage,\n      lastMessage: lastMessage,\n      subscribe: subscribe,\n      unsubscribe: unsubscribe\n    },\n    children: children\n  });\n};","map":{"version":3,"names":["_defineProperty","_slicedToArray","ownKeys","e","r","t","Object","keys","getOwnPropertySymbols","o","filter","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","arguments","length","forEach","getOwnPropertyDescriptors","defineProperties","defineProperty","createContext","useContext","useState","useEffect","useCallback","WS_URL","useAuth","jsx","_jsx","WebSocketContext","connected","sendMessage","lastMessage","subscribe","unsubscribe","useWebSocket","WebSocketProvider","_ref","children","_useAuth","user","token","_useState","_useState2","socket","setSocket","_useState3","_useState4","setConnected","_useState5","_useState6","setLastMessage","_useState7","_useState8","subscriptions","setSubscriptions","getWsUrl","id","connectWebSocket","ws","WebSocket","onopen","console","log","onmessage","event","message","JSON","parse","data","type","error","onclose","setTimeout","onerror","close","cleanup","send","stringify","channel","callback","prev","newSubscriptions","Provider","value"],"sources":["/home/runner/workspace/mobile/contexts/WebSocketContext.tsx"],"sourcesContent":["\"use client\"\n\nimport type React from \"react\"\nimport { createContext, useContext, useState, useEffect, useCallback } from \"react\"\nimport { WS_URL } from \"../config/environment\"\nimport { useAuth } from \"./AuthContext\"\n\nexport interface WebSocketMessage {\n  type: string\n  data?: Record<string, unknown>\n}\n\nexport interface WebSocketContextType {\n  connected: boolean\n  sendMessage: (message: WebSocketMessage) => void\n  lastMessage: WebSocketMessage | null\n  subscribe: (channel: string, callback: (data: Record<string, unknown>) => void) => () => void\n  unsubscribe: (channel: string) => void\n}\n\nconst WebSocketContext = createContext<WebSocketContextType>({\n  connected: false,\n  sendMessage: () => {},\n  lastMessage: null,\n  subscribe: () => () => {},\n  unsubscribe: () => {},\n})\n\nexport const useWebSocket = () => useContext(WebSocketContext)\n\nexport const WebSocketProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\n  const { user, token } = useAuth()\n  const [socket, setSocket] = useState<WebSocket | null>(null)\n  const [connected, setConnected] = useState<boolean>(false)\n  const [lastMessage, setLastMessage] = useState<WebSocketMessage | null>(null)\n  const [subscriptions, setSubscriptions] = useState<{\n    [key: string]: (data: any) => void\n  }>({})\n\n  const getWsUrl = () => {\n    return `${WS_URL}/${user?.id}?token=${token}`\n  }\n\n  const connectWebSocket = useCallback(() => {\n    if (!token || !user) return\n\n    const ws = new WebSocket(getWsUrl())\n\n    ws.onopen = () => {\n      console.log(\"WebSocket connected\")\n      setConnected(true)\n    }\n\n    ws.onmessage = (event) => {\n      try {\n        const message = JSON.parse(event.data)\n        setLastMessage(message)\n\n        // Notify subscribers about the new message\n        if (message.type && subscriptions[message.type]) {\n          subscriptions[message.type](message.data)\n        }\n      } catch (error) {\n        console.error(\"Error parsing WebSocket message:\", error)\n      }\n    }\n\n    ws.onclose = () => {\n      console.log(\"WebSocket disconnected\")\n      setConnected(false)\n      // Try to reconnect after a delay\n      setTimeout(() => {\n        if (token && user) {\n          connectWebSocket()\n        }\n      }, 5000)\n    }\n\n    ws.onerror = (error) => {\n      console.error(\"WebSocket error:\", error)\n      ws.close()\n    }\n\n    setSocket(ws)\n\n    return () => {\n      ws.close()\n    }\n  }, [token, user, subscriptions])\n\n  useEffect(() => {\n    if (token && user) {\n      const cleanup = connectWebSocket()\n      return cleanup\n    }\n  }, [token, user, connectWebSocket])\n\n  const sendMessage = useCallback(\n    (message: WebSocketMessage) => {\n      if (socket && connected) {\n        socket.send(JSON.stringify(message))\n      }\n    },\n    [socket, connected],\n  )\n\n  const subscribe = useCallback(\n    (channel: string, callback: (data: any) => void) => {\n      setSubscriptions((prev) => ({ ...prev, [channel]: callback }))\n      return () => {\n        unsubscribe(channel)\n      }\n    },\n    [],\n  )\n\n  const unsubscribe = useCallback(\n    (channel: string) => {\n      setSubscriptions((prev) => {\n        const newSubscriptions = { ...prev }\n        delete newSubscriptions[channel]\n        return newSubscriptions\n      })\n    },\n    [],\n  )\n\n  return (\n    <WebSocketContext.Provider\n      value={{ connected, sendMessage, lastMessage, subscribe, unsubscribe }}\n    >\n      {children}\n    </WebSocketContext.Provider>\n  )\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}